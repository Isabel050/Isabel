---
title: "ThreatNet Israel"
author: "Meusel et al."
output:
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: minty # We can set color themes!
      #Also check out help on bs_themer
    vertical_layout: fill
    orientation: rows
    source_code: embed
# If we Output HTML, this allows Latex for the Documentation:  
# mathjax: "http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
runtime: shiny
---


```{r setup, include=FALSE}
library(tidyverse)
library(shiny)
library(flexdashboard)

source("Stochastic.r", local = TRUE)
load("results.RData")
```



Sidebar {.sidebar}
=====================================

### Model Inputs

```{r}
selectInput(
  inputId = "Disease_Scenario",
  label = "Disease Scenario",
  choices = Disease_names,
  selected = 1,
  multiple = FALSE
)
sliderInput(
  inputId = "Threshold",
  label = "Detections needed to confirm disease",
  min = 1,
  max = 5,
  value = 1,
  step = 2,
  ticks = FALSE
)
sliderInput(
  inputId = "lag",
  label = "Average time between being infectious and seeking care",
  min = 0,
  max = 7,
  value = 7,
  step = 3.5,
  ticks = FALSE
)
```

Simulations
=======================================================================

Row
-----------------------------------------------------------------------

### Simulation explanation and parameters
The blue line shows the average outbreak progression, and the grey lines are individual random runs of the simulation.
Note that in some runs the outbreak may die out, which is why the number of visible grey lines may be smaller than the number of replicates N.
The red dots show when each outbreak is detected. This data is regenerated every time you press 'Run Simulations'.
The dashed grey lines show the 10th, 50th, and 90th percentiles for the day at detection and the number of cases at detection.
You can either select individual hospitals to participate in ThreatNet, or select the K largest hospitals by number of visitors.

```{r}
div(style = "display: flex;",
  actionButton("run", "Run N simulations", style = "margin-right: 5px;"),
  div(style = "width: 100px;", numericInput("rep", label = NULL, value = 10, min = 1,))
)
selectizeInput(
  inputId = "selected_hospitals",
  label = "Hospitals participating in Threatnet",
  choices = Hospital_visitors$Hospital,
  selected = Hospital_visitors$Hospital[1:6],
  multiple = TRUE,
  options = list(placeholder = "Select hospitals...")
)
div(style = "display: flex;",
  actionButton("select_top_n", "Select K largest hospitals", style = "margin-right: 5px;"),
  div(style = "width: 100px;", numericInput("top_n", label = NULL, value = 1,
            min = 1, max = length(Hospital_visitors$Hospital)))
)
```

###
```{r}
# set figure height
simulated_data <- eventReactive(input$run, {
  # Calculate average rate for the selected hospitals
  run_SEIR(
    disease_name = input$Disease_Scenario[[1]],
    rep = input$rep,
    threshold = input$Threshold,
    lag = input$lag,
    p = coverage(input$selected_hospitals) * delta * tau
  )
})

observeEvent(input$select_top_n, {
  # Check if the input is within the available range
  if (input$top_n >= 1 && input$top_n <= length(Hospital_visitors$Hospital)) {
    # Select the top N hospitals
    top_n_hospitals <- head(Hospital_visitors$Hospital, n = input$top_n)
    updateSelectizeInput(session, "selected_hospitals", selected = top_n_hospitals)
  }
})

renderPlot({
  data <- simulated_data()
  plot_SEIR(data)
})
```

Cost-effectiveness
=======================================================================

Row
-----------------------------------------------------------------------

### Costs of ThreatNet Israel
Costs include upfront and running costs, annualized over a ten-year time horizon. For details see the associated article.
The blue line is the median outcome, and the grey area shows the 10th and 90th percentile of the outcomes.
The stochastic simulation was pre-run 1000 times for each cost level.
You can choose whether to display time until detection or cases at detection on the y-axis.


```{r}
selectInput(
  inputId = "cases",
  label = "Y-axis of costs plot",
  choices = c("Cases at detection" = TRUE, "Time until detection" = FALSE),
  multiple = FALSE
)
```

###
```{r}
subset_data <- reactive({
  results %>% 
    filter(d == input$Disease_Scenario, t == input$Threshold, output_cases == input$cases, lag == input$lag)
})

renderPlot({plot_cost(subset_data())})
```

Model Documentation
=======================================================================

Row
-----------------------------------------------------------------------
```{r test, child="Documentation.RMD", eval=TRUE, local=TRUE}
```
